"use strict";(()=>{var e={};e.id=113,e.ids=[113],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3292:e=>{e.exports=require("fs/promises")},1017:e=>{e.exports=require("path")},1135:(e,o,r)=>{r.r(o),r.d(o,{headerHooks:()=>$,originalPathname:()=>y,patchFetch:()=>E,requestAsyncStorage:()=>d,routeModule:()=>h,serverHooks:()=>P,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>w});var t={};r.r(t),r.d(t,{POST:()=>g,dynamic:()=>m});var s=r(5419),a=r(9108),i=r(9678),n=r(8070),l=r(3292),c=r(917);class p{constructor(){if(this.baseUrl="https://image-api.photoroom.com/v2/edit",this.maxRetries=3,this.retryDelay=1e3,this.token=c.yp,console.log("\uD83D\uDD11 PhotoRoom token:",this.token?"SET":"NOT SET"),!this.token)throw Error("PHOTOROOM_TOKEN is required")}async removeBackground(e){console.log("\uD83D\uDE80 Starting PhotoRoom API call...");let o=new FormData,r=new Blob([new Uint8Array(e)],{type:"image/jpeg"});o.append("imageFile",r,"image.jpg"),o.append("background.color","FFFFFF"),o.append("outputSize","2000x2000"),o.append("position.gravity","center"),o.append("padding","0.14"),o.append("export.format","jpg");let t=null;for(let e=1;e<=this.maxRetries;e++)try{console.log(`ðŸ“¡ PhotoRoom API attempt ${e}/${this.maxRetries}`);let r=await fetch(this.baseUrl,{method:"POST",headers:{Accept:"image/png, application/json","x-api-key":this.token},body:o});if(console.log(`ðŸ“Š PhotoRoom API response status: ${r.status}`),!r.ok){let e=await r.json().catch(()=>({}));console.error(`âŒ PhotoRoom API error:`,e);let o=`PhotoRoom API error (${r.status})`;throw e.error?o+=`: ${"string"==typeof e.error?e.error:JSON.stringify(e.error)}`:e.message?o+=`: ${e.message}`:e.detail?o+=`: ${e.detail}`:o+=": Unknown error",429===r.status?o="Too many requests to PhotoRoom API":401===r.status?o="Invalid PhotoRoom API token":r.status>=500&&(o=`PhotoRoom server error: ${e.error||"Unknown error"}`),Error(o)}let t=await r.arrayBuffer(),s=Buffer.from(t);return console.log(`âœ… PhotoRoom API success! Processed image size: ${s.length} bytes`),s}catch(r){if(console.error(`âŒ PhotoRoom API attempt ${e} failed:`,(t=r instanceof Error?r:Error(String(r))).message),e===this.maxRetries)break;let o=this.retryDelay*Math.pow(2,e-1);console.log(`â³ Retrying in ${o}ms...`),await new Promise(e=>setTimeout(e,o))}throw console.error("\uD83D\uDC80 All PhotoRoom API attempts failed"),t||Error("Failed to remove background after retries")}async checkHealth(){try{return(await fetch(`${this.baseUrl}/health`,{headers:{Authorization:`Bearer ${this.token}`}})).ok}catch{return!1}}}let u=0,m="force-dynamic";async function g(e){try{let o;let{sku:r,files:t}=await e.json();if(!r||!t||0===t.length)return n.Z.json({error:"SKU and files are required"},{status:400});console.log(`ðŸ”§ Processing SKU: ${r}, ${t.length} files`);try{o=new p,console.log("\uD83D\uDD27 PhotoRoomService initialized successfully")}catch(e){return console.error("âŒ Failed to initialize PhotoRoomService:",e),n.Z.json({error:"PhotoRoom service initialization failed"},{status:500})}await (0,c.Tw)(r);let s=t.filter(e=>"image"===e.type),a=t.filter(e=>"video"===e.type),i=1,m=[];for(let e of a){let o=`${r}_${String(i).padStart(3,"0")}.mp4`;m.push({id:e.id,originalName:e.fileName,finalName:o,status:"skipped"}),i++}console.log(`ðŸŽ¯ Starting processing of ${s.length} image files...`);for(let e=0;e<s.length;e+=c.$b){let t=s.slice(e,e+c.$b);for(console.log(`ðŸ“¦ Processing batch ${Math.floor(e/c.$b)+1} with ${t.length} files...`);u>=c.$b;)console.log("â³ Waiting for active requests to complete..."),await new Promise(e=>setTimeout(e,1e3));u++,console.log(`ðŸš€ Active requests: ${u}`);let a=t.map(async e=>{try{console.log(`ðŸ” Processing file: ${e.fileName}`);let t=i++,s=`${r}_${String(t).padStart(3,"0")}.jpg`,a=(0,c.vl)(r,e.fileName),n=await (0,l.readFile)(a);console.log(`ðŸ“¸ Original file size: ${n.length} bytes`),console.log("\uD83D\uDE80 Calling PhotoRoom API...");let p=await o.removeBackground(n);console.log(`âœ… PhotoRoom processing completed, processed size: ${p.length} bytes`);let u=(0,c.vl)(r,s);await (0,l.writeFile)(u,p),console.log(`âœ… Processed file saved to: ${u}`),await (0,l.access)(u);let m=`${c.CT}/uploads/${r}/${s}`;return{id:e.id,originalName:e.originalName,finalName:s,status:"done",previewUrl:m}}catch(n){console.error(`âŒ Error processing file ${e.fileName}:`,n),console.error(`âŒ Error details:`,{name:n instanceof Error?n.name:"Unknown",message:n instanceof Error?n.message:"Unknown error",stack:n instanceof Error?n.stack:void 0,fileName:e.fileName,originalName:e.originalName});let o=i++,t=e.fileName.split(".").pop()||"jpg",s=`${r}_${String(o).padStart(3,"0")}.${t}`,a=`${c.CT}/uploads/${r}/${e.fileName}`;return{id:e.id,originalName:e.originalName,finalName:s,status:"error",error:n instanceof Error?n.message:"Unknown error",previewUrl:a}}}),n=await Promise.all(a);m.push(...n),u--}return console.log(`âœ… Processing completed for SKU ${r}: ${m.length} results`),n.Z.json({success:!0,sku:r,results:m})}catch(e){return console.error("Process error:",e),n.Z.json({error:"Internal server error"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/process/route",pathname:"/api/process",filename:"route",bundlePath:"app/api/process/route"},resolvedPagePath:"/Users/mak/Desktop/PhotoSku/src/app/api/process/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:d,staticGenerationAsyncStorage:f,serverHooks:P,headerHooks:$,staticGenerationBailout:w}=h,y="/api/process/route";function E(){return(0,i.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:f})}},917:(e,o,r)=>{r.d(o,{$3:()=>s,$b:()=>n,CT:()=>t,My:()=>a,Tw:()=>u,sQ:()=>c,vl:()=>p,yp:()=>i});let t=process.env.PUBLIC_ORIGIN||"",s=process.env.TELEGRAM_BOT_TOKEN||"",a=process.env.TELEGRAM_CHAT_ID||"";if(!t)throw Error("PUBLIC_ORIGIN is required");if(!s)throw Error("TELEGRAM_BOT_TOKEN is required");if(!a)throw Error("TELEGRAM_CHAT_ID is required");let i=process.env.PHOTOROOM_TOKEN||"";i||console.warn("PHOTOROOM_TOKEN is not set. PhotoRoom API will not work.");let n=3,l=process.env.RAILWAY_SERVICE_NAME?"/tmp/uploads":"./uploads",c=process.env.RAILWAY_SERVICE_NAME?"/tmp":"./tmp";function p(e,o){let t=r(1017).join(l,e,o);if(!t.startsWith(l))throw Error(`Invalid path: ${t}`);return t}async function u(e){let o=r(3292),t=r(1017).join(l,e);try{return await o.mkdir(t,{recursive:!0}),console.log(`Created directory: ${t}`),t}catch(e){throw console.error(`Error creating directory ${t}:`,e),e}}}};var o=require("../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),t=o.X(0,[638,206],()=>r(1135));module.exports=t})();