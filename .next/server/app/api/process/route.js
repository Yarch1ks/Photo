"use strict";(()=>{var e={};e.id=113,e.ids=[113],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3292:e=>{e.exports=require("fs/promises")},1017:e=>{e.exports=require("path")},6031:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>k,originalPathname:()=>P,patchFetch:()=>v,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>w,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>y});var o={};t.r(o),t.d(o,{POST:()=>h});var a=t(5419),i=t(9108),s=t(9678),n=t(8070),p=t(3292),l=t(1017);let c=process.env.PHOTOROOM_TOKEN||"";class u{constructor(){if(this.baseUrl="https://image-api.photoroom.com/v2/edit",this.maxRetries=3,this.retryDelay=1e3,this.token=c,!this.token)throw Error("PHOTOROOM_TOKEN is required")}async removeBackground(e){let r=new FormData,t=new Blob([new Uint8Array(e)],{type:"image/jpeg"});r.append("imageFile",t,"image.jpg"),r.append("background.color","FFFFFF"),r.append("outputSize","2000x2000"),r.append("position.gravity","center"),r.append("padding","0.14"),r.append("export.format","jpg");let o=null;for(let e=1;e<=this.maxRetries;e++)try{let e=await fetch(this.baseUrl,{method:"POST",headers:{Accept:"image/png, application/json","x-api-key":this.token},body:r});if(!e.ok){let r=await e.json().catch(()=>({}));if(429===e.status)throw Error("Too many requests to PhotoRoom API");if(401===e.status)throw Error("Invalid PhotoRoom API token");if(e.status>=500)throw Error(`PhotoRoom server error: ${r.error||"Unknown error"}`);throw Error(`PhotoRoom API error: ${r.error||"Unknown error"}`)}let t=await e.arrayBuffer();return Buffer.from(t)}catch(t){if(o=t instanceof Error?t:Error(String(t)),e===this.maxRetries)break;let r=this.retryDelay*Math.pow(2,e-1);await new Promise(e=>setTimeout(e,r))}throw o||Error("Failed to remove background after retries")}async checkHealth(){try{return(await fetch(`${this.baseUrl}/health`,{headers:{Authorization:`Bearer ${this.token}`}})).ok}catch{return!1}}}let d=0;async function h(e){try{let{sku:r,files:t}=await e.json();if(!r||!t||0===t.length)return n.Z.json({error:"SKU and files are required"},{status:400});let o=new u,a=[],i=t.filter(e=>"image"===e.type),s=t.filter(e=>"video"===e.type);i.length,s.length;let c=1,h=[];for(let e of s){let t=`${r}_${String(c).padStart(3,"0")}.mp4`;a.push({id:e.id,originalName:e.fileName,finalName:t,status:"skipped"}),c++}for(let e=0;e<i.length;e+=3){let t=i.slice(e,e+3);for(;d>=3;)await new Promise(e=>setTimeout(e,1e3));d++;let s=t.map(async e=>{try{let t=c++,a=`${r}_${String(t).padStart(3,"0")}.jpg`,i=(0,l.join)(process.cwd(),"temp",r,e.fileName),s=await (0,p.readFile)(i),n=await o.removeBackground(s),u=(0,l.join)(process.cwd(),"temp",r,a);await (0,p.writeFile)(u,n);let d=await (0,p.open)(u,"r+");return await d.sync(),await d.close(),console.log(`Processed file saved to: ${u}`),h.push(i),{id:e.id,originalName:e.originalName,finalName:a,status:"done",processedPath:u}}catch(i){console.error(`Error processing file ${e.fileName}:`,i);let t=c++,o=e.fileName.split(".").pop()||"jpg",a=`${r}_${String(t).padStart(3,"0")}.${o}`;return{id:e.id,originalName:e.originalName,finalName:a,status:"error",error:i instanceof Error?i.message:"Unknown error",processedPath:(0,l.join)(process.cwd(),"temp",r,e.fileName)}}}),n=await Promise.all(s);a.push(...n),d--}let m=(0,l.join)(process.cwd(),"temp",r,"process-info.json");return await (0,p.writeFile)(m,JSON.stringify(a,null,2)),console.log("Original files preserved for debugging:",h),n.Z.json({success:!0,results:a,sku:r})}catch(e){return console.error("Process error:",e),n.Z.json({error:"Internal server error"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/process/route",pathname:"/api/process",filename:"route",bundlePath:"app/api/process/route"},resolvedPagePath:"/Users/mak/Desktop/PhotoSku/src/app/api/process/route.ts",nextConfigOutput:"export",userland:o}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:w,headerHooks:k,staticGenerationBailout:y}=m,P="/api/process/route";function v(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:g})}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[638,206],()=>t(6031));module.exports=o})();