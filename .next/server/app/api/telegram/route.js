"use strict";(()=>{var e={};e.id=490,e.ids=[490],e.modules={7225:e=>{e.exports=require("lodash/defaults")},7047:e=>{e.exports=require("lodash/difference")},8579:e=>{e.exports=require("lodash/flatten")},5452:e=>{e.exports=require("lodash/isPlainObject")},215:e=>{e.exports=require("lodash/union")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{e.exports=require("assert")},4300:e=>{e.exports=require("buffer")},2057:e=>{e.exports=require("constants")},2361:e=>{e.exports=require("events")},7147:e=>{e.exports=require("fs")},3292:e=>{e.exports=require("fs/promises")},1415:e=>{e.exports=require("node:events")},7561:e=>{e.exports=require("node:fs")},3977:e=>{e.exports=require("node:fs/promises")},9411:e=>{e.exports=require("node:path")},4492:e=>{e.exports=require("node:stream")},6915:e=>{e.exports=require("node:string_decoder")},1041:e=>{e.exports=require("node:url")},1017:e=>{e.exports=require("path")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},9796:e=>{e.exports=require("zlib")},5317:(e,r,o)=>{o.r(r),o.d(r,{headerHooks:()=>$,originalPathname:()=>I,patchFetch:()=>x,requestAsyncStorage:()=>m,routeModule:()=>h,serverHooks:()=>y,staticGenerationAsyncStorage:()=>v,staticGenerationBailout:()=>E});var t={};o.r(t),o.d(t,{POST:()=>g});var s=o(5419),i=o(9108),n=o(9678),a=o(8070),l=o(3292),c=o(1017),u=o(7147),p=o(9860),d=o.n(p),f=o(917);async function g(e){try{let{sku:r,files:o}=await e.json();if(!r||!o||0===o.length)return a.Z.json({error:"SKU and files are required"},{status:400});console.log(`📦 Starting Telegram processing for SKU: ${r}, ${o.length} files`);let t=f.My.startsWith("-")?parseInt(f.My):f.My;console.log("Using chatId:",{original:f.My,numeric:t});let s=process.env.RAILWAY_SERVICE_NAME?"/tmp/uploads":"./uploads",i=(0,c.join)(s,r);try{await (0,l.access)(i),console.log(`✅ SKU directory exists: ${i}`)}catch(e){return console.error(`❌ SKU directory not found: ${i}`),a.Z.json({error:`No processed files found for SKU ${r}`},{status:404})}let n=[];for(let e of o){let r=(0,c.join)(i,e.finalName);try{let o=await (0,l.stat)(r);o.isFile()?(n.push(e),console.log(`✅ File exists: ${r} (${o.size} bytes)`)):console.error(`❌ Path is not a file: ${r}`)}catch(e){console.error(`❌ File not found: ${r}`)}}if(0===n.length)return a.Z.json({error:"No valid files found for this SKU"},{status:400});console.log(`📁 Found ${n.length} valid files for ZIP creation`);let p=`https://api.telegram.org/bot${f.$3}/sendDocument`,g=Date.now(),h=`photos_${r}_${g}.zip`,m=(0,c.join)(f.sQ,h);console.log(`🗜️ Creating ZIP archive: ${m}`);try{await new Promise((e,r)=>{let o=(0,u.createWriteStream)(m),t=d()("zip",{zlib:{level:9}});for(let s of(o.on("close",()=>{console.log(`✅ ZIP archive created: ${m}, size: ${t.pointer()} bytes`),e(!0)}),o.on("error",e=>{console.error("❌ Error writing ZIP file:",e),r(e)}),t.on("error",e=>{console.error("❌ Archiver error:",e),r(e)}),t.on("warning",e=>{"ENOENT"===e.code?console.warn("⚠️ Archiver warning:",e):r(e)}),t.pipe(o),n)){let e=(0,c.join)(i,s.finalName);console.log(`📄 Adding file to archive: ${s.finalName}`);try{let r=(0,u.statSync)(e);t.append((0,u.readFileSync)(e),{name:s.finalName}),console.log(`✅ Added file to archive: ${s.finalName} (${r.size} bytes)`)}catch(e){console.error(`❌ Error adding file ${s.finalName} to archive:`,e),r(Error(`Failed to add file ${s.finalName} to archive: ${e}`));return}}console.log("\uD83C\uDFC1 Finalizing ZIP archive..."),t.finalize()}),console.log("✅ ZIP archive finalized successfully"),console.log(`📖 Reading ZIP file: ${m}`);let e=await (0,l.readFile)(m);console.log(`✅ ZIP file size: ${e.length} bytes`);let o=new File([new Uint8Array(e)],`${r}.zip`,{type:"application/zip"}),s=new FormData;s.append("chat_id",String(t)),s.append("document",o),s.append("caption",`Обработанные фотографии для артикула: ${r}
Всего файлов: ${n.length}`),console.log("\uD83D\uDCE4 Sending to Telegram with FormData:",{chatId:t,fileName:`${r}.zip`,fileSize:e.byteLength});let f=await fetch(p,{method:"POST",body:s});if(!f.ok){let e=await f.text();return console.error("❌ Telegram API error:",e),a.Z.json({error:"Failed to send file to Telegram"},{status:500})}let g=await f.json();console.log("✅ File sent to Telegram successfully:",g);try{await (0,l.unlink)(m),console.log(`🗑️ Temporary ZIP file deleted: ${m}`)}catch(e){console.error(`⚠️ Error deleting temporary ZIP file:`,e)}return a.Z.json({success:!0,message:"File sent to Telegram successfully",telegramMessageId:g.result.message_id})}catch(e){return console.error("❌ Error creating ZIP archive:",e),a.Z.json({error:"Failed to create ZIP archive"},{status:500})}}catch(e){return console.error("❌ Telegram API error:",e),a.Z.json({error:"Internal server error"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/telegram/route",pathname:"/api/telegram",filename:"route",bundlePath:"app/api/telegram/route"},resolvedPagePath:"/Users/mak/Desktop/PhotoSku/src/app/api/telegram/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:m,staticGenerationAsyncStorage:v,serverHooks:y,headerHooks:$,staticGenerationBailout:E}=h,I="/api/telegram/route";function x(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:v})}},917:(e,r,o)=>{o.d(r,{$3:()=>s,$b:()=>a,CT:()=>t,My:()=>i,Tw:()=>p,sQ:()=>c,vl:()=>u,yp:()=>n});let t=process.env.PUBLIC_ORIGIN||"",s=process.env.TELEGRAM_BOT_TOKEN||"",i=process.env.TELEGRAM_CHAT_ID||"";if(!t)throw Error("PUBLIC_ORIGIN is required");if(!s)throw Error("TELEGRAM_BOT_TOKEN is required");if(!i)throw Error("TELEGRAM_CHAT_ID is required");let n=process.env.PHOTOROOM_TOKEN||"",a=3,l=process.env.RAILWAY_SERVICE_NAME?"/tmp/uploads":"./uploads",c=process.env.RAILWAY_SERVICE_NAME?"/tmp":"./tmp";function u(e,r){let t=o(1017).join(l,e,r);if(!t.startsWith(l))throw Error(`Invalid path: ${t}`);return t}async function p(e){let r=o(3292),t=o(1017).join(l,e);try{return await r.mkdir(t,{recursive:!0}),console.log(`Created directory: ${t}`),t}catch(e){throw console.error(`Error creating directory ${t}:`,e),e}}}};var r=require("../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[638,206,860],()=>o(5317));module.exports=t})();