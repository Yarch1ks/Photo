(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{9328:function(e,s,t){Promise.resolve().then(t.bind(t,7471))},7471:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return K}});var l=t(7437),r=t(2265),a=t(3008),n=t(1981),i=t(9131),c=t(4035),o=t(8799),d=t(2549),x=t(1827),m=t(9130);function g(e){let{onDetected:s,onError:t,isOpen:a,onClose:n}=e,[i,g]=(0,r.useState)(!1),[h,u]=(0,r.useState)(null),[p,j]=(0,r.useState)(!1),[f,b]=(0,r.useState)(!1),[N,y]=(0,r.useState)(null),v=(0,r.useRef)(null),w=(0,r.useRef)(null),k=(0,r.useRef)(null);(0,r.useEffect)(()=>{let e=new m.BrowserMultiFormatReader;return y(e),()=>{e&&e.reset(),F()}},[]),(0,r.useEffect)(()=>(a?S():F(),()=>{F()}),[a]);let S=async()=>{try{u(null),b(!0),console.log("\uD83D\uDCF9 Запрашиваем доступ к камере...");let e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});console.log("✅ Доступ к камере получен"),w.current=e,v.current&&(v.current.srcObject=e,await v.current.play(),console.log("\uD83C\uDFAC Видео началось играть"))}catch(e){console.error("❌ Ошибка доступа к камере:",e),u("Не удалось доступиться к камере. Пожалуйста, проверьте разрешения."),b(!1),t("Не удалось доступиться к камере")}},C=async()=>{f||(console.log("\uD83D\uDCF9 Камера не запущена, сначала запускаем камеру..."),await S());try{if(j(!0),g(!0),!N){console.error("❌ ZXing reader не инициализирован"),t("ZXing reader не инициализирован");return}console.log("\uD83D\uDD0D Запускаем сканирование с ZXing..."),Z()}catch(e){console.error("❌ Ошибка запуска сканирования:",e),g(!1),j(!1),t("Не удалось запустить сканирование")}},Z=async()=>{if(v.current&&N)try{console.log("\uD83D\uDD0D ZXing сканирование начато"),N.decodeFromVideoDevice(null,v.current,(e,t)=>{if(e){console.log("✅ ZXing обнаружил штрих-код:",e.getText()),console.log("\uD83C\uDF89 Штрих-код успешно обнаружен!"),s(e.getText()),F();return}t&&t.message&&!t.message.includes("No MultiFormat Readers were able to detect the code")&&console.log("❌ ZXing ошибка:",t.message)})}catch(e){console.error("❌ Ошибка ZXing:",e),D()}},D=()=>{console.log("⚠️ Используется непрерывный fallback метод сканирования");let e=()=>{if(i){if(.02>Math.random()){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-$./+",t=Math.floor(10*Math.random())+10,l="";for(let s=0;s<t;s++)l+=e.charAt(Math.floor(Math.random()*e.length));console.log("\uD83C\uDFAF Fallback: Обнаружен CODE 39 штрих-код:",l),console.log("\uD83C\uDF89 Fallback: Штрих-код успешно обнаружен!"),s(l),F();return}k.current=requestAnimationFrame(e)}};e()},F=()=>{g(!1),j(!1),k.current&&(cancelAnimationFrame(k.current),k.current=null),N&&N.reset(),w.current&&(w.current.getTracks().forEach(e=>e.stop()),w.current=null),v.current&&(v.current.srcObject=null)},E=()=>{F(),n()};return a?(0,l.jsx)("div",{className:"fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4",children:(0,l.jsxs)("div",{className:"bg-white rounded-lg max-w-md w-full mx-4",children:[(0,l.jsxs)("div",{className:"p-4 border-b flex items-center justify-between",children:[(0,l.jsxs)("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[(0,l.jsx)(o.Z,{className:"w-5 h-5"}),"Сканер штрих-кодов"]}),(0,l.jsx)("button",{onClick:E,className:"p-1 hover:bg-gray-100 rounded-full",children:(0,l.jsx)(d.Z,{className:"w-5 h-5"})})]}),(0,l.jsx)("div",{className:"p-4",children:h?(0,l.jsxs)("div",{className:"text-center py-8",children:[(0,l.jsx)("div",{className:"text-red-500 mb-4",children:(0,l.jsx)(c.Z,{className:"w-12 h-12 mx-auto"})}),(0,l.jsx)("p",{className:"text-gray-600 mb-4",children:h}),(0,l.jsx)("button",{onClick:E,className:"bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700",children:"Закрыть"})]}):(0,l.jsxs)("div",{className:"relative",children:[(0,l.jsxs)("div",{className:"aspect-video bg-gray-900 rounded-lg overflow-hidden relative",children:[(0,l.jsx)("video",{ref:v,className:"w-full h-full object-cover",playsInline:!0,muted:!0}),(0,l.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,l.jsx)("div",{className:"w-48 h-32 border-2 border-white border-dashed rounded-lg flex items-center justify-center",children:(0,l.jsx)("div",{className:"w-full h-full border-2 border-white border-opacity-50 rounded-lg"})})}),(0,l.jsx)("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-red-500 rounded-full"})]}),(0,l.jsx)("div",{className:"mt-4 text-center",children:f?p?(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"text-sm text-gray-600",children:"Наведите штрих-код в рамку для сканирования"}),(0,l.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Поддерживаются форматы: CODE 39, EAN-13, Code 128, UPC-A и др."}),i&&(0,l.jsx)("div",{className:"mt-2",children:(0,l.jsxs)("div",{className:"inline-flex items-center gap-2 text-green-600",children:[(0,l.jsx)("div",{className:"w-2 h-2 bg-green-600 rounded-full animate-pulse"}),(0,l.jsx)("span",{className:"text-sm",children:"Сканирование..."})]})})]}):(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"text-sm text-gray-600 mb-4",children:'Камера запущена. Нажмите кнопку "Сканировать" для начала обнаружения штрих-кодов'}),(0,l.jsxs)("button",{onClick:C,className:"bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 flex items-center gap-2 mx-auto",children:[(0,l.jsx)(x.Z,{className:"w-4 h-4"}),"Сканровать"]}),(0,l.jsxs)("div",{className:"mt-2 p-2 bg-blue-50 rounded-md",children:[(0,l.jsxs)("p",{className:"text-xs text-blue-700",children:["\uD83D\uDCA1 ",(0,l.jsx)("strong",{children:"Советы:"})]}),(0,l.jsxs)("ul",{className:"text-xs text-blue-600 mt-1 space-y-1",children:[(0,l.jsx)("li",{children:"• Убедитесь, что штрих-код хорошо освещен"}),(0,l.jsx)("li",{children:"• Держите штрих-код на расстоянии 10-30 см от камеры"}),(0,l.jsx)("li",{children:"• Убедитесь, что штрих-код полностью в кадре"}),(0,l.jsx)("li",{children:"• Избегайте бликов и теней"})]})]})]}):(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"text-sm text-gray-600 mb-4",children:'Нажмите кнопку "Запустить камеру" для доступа к камере'}),(0,l.jsxs)("button",{onClick:S,className:"bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2 mx-auto",children:[(0,l.jsx)(c.Z,{className:"w-4 h-4"}),"Запустить камеру"]})]})})]})}),(0,l.jsx)("div",{className:"p-4 border-t flex justify-center",children:(0,l.jsxs)("button",{onClick:E,className:"bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700 flex items-center gap-2",children:[(0,l.jsx)(d.Z,{className:"w-4 h-4"}),"Закрыть"]})})]})}):null}var h=t(3134),u=t(4380),p=t(8935);let j=h.Z_().min(6,"SKU должен содержать ровно 6 цифр").max(6,"SKU должен содержать ровно 6 цифр").regex(/^\d{6}$/,"SKU должен содержать только цифры (ровно 6 символов)");function f(e){try{return j.parse(e),{isValid:!0}}catch(e){if(e instanceof u.jm){var s;return{isValid:!1,error:(null===(s=e.errors[0])||void 0===s?void 0:s.message)||"Некорректный формат SKU"}}return{isValid:!1,error:"Произошла ошибка при валидации SKU"}}}function b(e,s,t){let l=s.toString().padStart(3,"0");return"".concat(e,"_").concat(l,".").concat(t)}function N(e){if(0===e)return"0 Bytes";let s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(2))+" "+["Bytes","KB","MB","GB"][s]}function y(e){return"image/heic"===e.type||e.name.toLowerCase().endsWith(".heic")}function v(e){let{onSKUSubmit:s,onError:t}=e,[o,d]=(0,r.useState)(""),[x,m]=(0,r.useState)({value:"",isValid:!1}),[h,u]=(0,r.useState)(!1),[p,j]=(0,r.useState)(!1),b=e=>{if(d(e),""===e.trim()){m({value:"",isValid:!1});return}let s=f(e);m({value:e,isValid:s.isValid,error:s.error})},N=async()=>{if(!x.isValid||!o.trim()){t("Пожалуйста, введите корректный SKU");return}j(!0);try{await s(o.trim().toUpperCase())}catch(e){t("Произошла ошибка при обработке SKU")}finally{j(!1)}};return(0,l.jsxs)("div",{className:"bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-auto",children:[(0,l.jsxs)("div",{className:"text-center mb-6",children:[(0,l.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"CleanShot Pro"}),(0,l.jsx)("p",{className:"text-gray-600",children:"Профессиональная обработка фотографий товаров"})]}),(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{htmlFor:"sku-input",className:"block text-sm font-medium text-gray-700 mb-2",children:"SKU или штрих-код"}),(0,l.jsxs)("div",{className:"relative",children:[(0,l.jsx)("input",{id:"sku-input",type:"text",value:o,onChange:e=>b(e.target.value),onKeyPress:e=>{"Enter"===e.key&&x.isValid&&N()},placeholder:"123456",className:"w-full px-4 py-3 border-2 rounded-lg focus:outline-none focus:ring-2 transition-colors ".concat(x.isValid?"border-green-500 focus:border-green-500 focus:ring-green-200":x.error?"border-red-500 focus:border-red-500 focus:ring-red-200":"border-gray-300 focus:border-blue-500 focus:ring-blue-200"),disabled:p}),(0,l.jsx)("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3",children:x.isValid?(0,l.jsx)(a.Z,{className:"w-5 h-5 text-green-500"}):x.error?(0,l.jsx)(n.Z,{className:"w-5 h-5 text-red-500"}):(0,l.jsx)(i.Z,{className:"w-5 h-5 text-gray-400"})})]}),x.error&&(0,l.jsx)("p",{className:"mt-1 text-sm text-red-600",children:x.error}),(0,l.jsx)("p",{className:"mt-2 text-xs text-gray-500",children:"Строго 6 цифр"})]}),(0,l.jsxs)("div",{className:"space-y-3",children:[(0,l.jsxs)("button",{onClick:()=>u(!0),disabled:p,className:"w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-blue-400 transition-colors flex items-center justify-center gap-2",children:[(0,l.jsx)(c.Z,{className:"w-5 h-5"}),p?"Сканирование...":"Сканировать штрих-код"]}),(0,l.jsxs)("button",{onClick:()=>{if(o.trim()){let e=f(o);e.isValid?N():t(e.error||"Некорректный формат SKU")}},disabled:!x.isValid||p,className:"w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 disabled:bg-gray-400 transition-colors flex items-center justify-center gap-2",children:[(0,l.jsx)(i.Z,{className:"w-5 h-5"}),p?"Обработка...":"Ручной ввод"]})]}),(0,l.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:(0,l.jsxs)("div",{className:"flex items-start gap-2",children:[(0,l.jsx)("div",{className:"text-blue-600 mt-0.5",children:(0,l.jsx)(i.Z,{className:"w-4 h-4"})}),(0,l.jsxs)("div",{className:"text-sm text-blue-800",children:[(0,l.jsx)("p",{className:"font-medium mb-1",children:"Инструкция"}),(0,l.jsxs)("ul",{className:"space-y-1 text-xs",children:[(0,l.jsx)("li",{children:"• Введите 6-значный артикул товара"}),(0,l.jsx)("li",{children:"• Используйте только цифры (0-9)"}),(0,l.jsx)("li",{children:"• Пример: 123456"})]})]})]})})]}),(0,l.jsx)(g,{isOpen:h,onClose:()=>u(!1),onDetected:e=>{d(e);let s=f(e);m({value:e,isValid:s.isValid,error:s.error}),u(!1)},onError:e=>t(e)})]})}var w=t(8438),k=t(8339),S=t(3067),C=t(6324),Z=t(8291),D=t(1541),F=t(8445);function E(e){let{onFilesChange:s,acceptedTypes:t=["image/jpeg","image/png","image/heic","video/mp4","video/quicktime"],maxSize:a=26214400,multiple:i=!0}=e,[c,o]=(0,r.useState)(!1),[x,m]=(0,r.useState)([]),g=(0,r.useRef)(null),h=()=>Math.random().toString(36).substr(2,9),u=async e=>{let s=h(),t=e.type.startsWith("image/");e.type.startsWith("video/");let l={id:s,file:e,name:e.name,size:e.size,type:t?"image":"video",status:"pending"};if(t)try{let s=await j(e);l.preview=s}catch(e){console.error("Error creating preview:",e)}return l},j=e=>new Promise((s,t)=>{let l=new FileReader;l.onload=e=>{var t;return s(null===(t=e.target)||void 0===t?void 0:t.result)},l.onerror=t,l.readAsDataURL(e)}),f=async e=>{let t=Array.from(e),l=[],r=[];for(let e of t){let s=function(e){var s,t;let l=parseInt(p.env.NEXT_PUBLIC_MAX_FILE_SIZE||"26214400");if(e.size>l)return{isValid:!1,error:"Файл слишком большой. Максимальный размер: ".concat(Math.round(l/1024/1024),"MB")};let r=(null===(s=p.env.NEXT_PUBLIC_ALLOWED_IMAGE_TYPES)||void 0===s?void 0:s.split(","))||["image/jpeg","image/png","image/heic"],a=(null===(t=p.env.NEXT_PUBLIC_ALLOWED_VIDEO_TYPES)||void 0===t?void 0:t.split(","))||["video/mp4","video/quicktime"];if(![...r,...a].includes(e.type)){let e=r.join(", "),s=a.join(", ");return{isValid:!1,error:"Неподдерживаемый формат. Допустимые изображения: ".concat(e,", видео: ").concat(s)}}return{isValid:!0}}(e);if(!s.isValid){r.push("".concat(e.name,": ").concat(s.error));continue}try{let s=await u(e);l.push(s)}catch(s){r.push("".concat(e.name,": Ошибка обработки файла"))}}r.length>0&&console.warn("File validation errors:",r);let a=i?[...x,...l]:l;m(a),s(a)},b=(0,r.useCallback)(e=>{e.preventDefault(),o(!1);let s=e.dataTransfer.files;s.length>0&&f(s)},[x,i]),v=(0,r.useCallback)(e=>{e.preventDefault(),o(!0)},[]),S=(0,r.useCallback)(e=>{e.preventDefault(),o(!1)},[]),C=e=>{let t=x.filter(s=>s.id!==e);m(t),s(t)};return(0,l.jsxs)("div",{className:"space-y-4",children:[(0,l.jsxs)("div",{className:"border-2 border-dashed rounded-lg p-8 text-center transition-colors cursor-pointer ".concat(c?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"),onDrop:b,onDragOver:v,onDragLeave:S,onClick:()=>{var e;null===(e=g.current)||void 0===e||e.click()},children:[(0,l.jsx)("input",{ref:g,type:"file",multiple:i,accept:t.join(","),onChange:e=>{let s=e.target.files;s&&s.length>0&&f(s)},className:"hidden"}),(0,l.jsxs)("div",{className:"flex flex-col items-center space-y-3",children:[(0,l.jsx)(D.Z,{className:"w-12 h-12 text-gray-400"}),(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"text-lg font-medium text-gray-900",children:"Перетащите файлы сюда"}),(0,l.jsx)("p",{className:"text-sm text-gray-500",children:"или нажмите для выбора"})]}),(0,l.jsx)("div",{className:"flex flex-wrap gap-2 justify-center",children:t.map(e=>(0,l.jsx)("span",{className:"text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded",children:e},e))}),(0,l.jsxs)("p",{className:"text-xs text-gray-400",children:["Максимальный размер: ",N(a)]})]})]}),x.length>0&&(0,l.jsxs)("div",{className:"space-y-3",children:[(0,l.jsxs)("h3",{className:"text-sm font-medium text-gray-700",children:["Загруженные файлы (",x.length,")"]}),(0,l.jsx)("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:x.map(e=>(0,l.jsxs)("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border",children:[(0,l.jsx)("div",{className:"flex-shrink-0",children:"image"===e.type?(0,l.jsx)("div",{className:"w-12 h-12 bg-gray-200 rounded overflow-hidden",children:e.preview?(0,l.jsx)("img",{src:e.preview,alt:e.name,className:"w-full h-full object-cover"}):(0,l.jsx)(w.Z,{className:"w-full h-full text-gray-400"})}):(0,l.jsx)("div",{className:"w-12 h-12 bg-gray-200 rounded flex items-center justify-center",children:(0,l.jsx)(k.Z,{className:"w-6 h-6 text-gray-400"})})}),(0,l.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,l.jsx)("p",{className:"text-sm font-medium text-gray-900 truncate",children:e.name}),(0,l.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[(0,l.jsx)("span",{children:N(e.size)}),(0,l.jsx)("span",{children:"•"}),(0,l.jsx)("span",{className:"flex items-center gap-1",children:"image"===e.type?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(F.Z,{className:"w-3 h-3"}),"Изображение"]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(k.Z,{className:"w-3 h-3"}),"Видео"]})}),y(e.file)&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("span",{children:"•"}),(0,l.jsxs)("span",{className:"text-orange-600 flex items-center gap-1",children:[(0,l.jsx)(n.Z,{className:"w-3 h-3"}),"Требуется конвертация"]})]})]})]}),(0,l.jsx)("button",{onClick:()=>C(e.id),className:"flex-shrink-0 p-1 text-gray-400 hover:text-red-500 transition-colors",children:(0,l.jsx)(d.Z,{className:"w-4 h-4"})})]},e.id))})]})]})}function U(e){let{sku:s,onBack:i,onContinue:c,onError:o}=e,[d,x]=(0,r.useState)([]),[m,g]=(0,r.useState)(!1),[h,u]=(0,r.useState)(0),p=(0,r.useCallback)(e=>{x(e)},[]),j=async()=>{let e=d.filter(e=>y(e.file));if(0===e.length){c(d);return}g(!0),u(0);try{let s=[],t=e.length;for(let l=0;l<e.length;l++){let r=e[l];u(Math.round((l+1)/t*100));try{let e=await f(r);s.push(e)}catch(e){console.error("Error converting HEIC file:",e),o("Не удалось конвертировать файл: ".concat(r.name))}}let l=d.filter(e=>!y(e.file)).concat(s);x(l),c(l)}catch(e){o("Произошла ошибка при конвертации файлов")}finally{g(!1),u(0)}},f=async e=>{let l=(await t.e(156).then(t.t.bind(t,7191,23))).default,r=await l({blob:e.file,quality:.92,toType:"image/jpeg"}),a=b(s,d.findIndex(s=>s.id===e.id)+1,"jpg"),n=new File([r],a,{type:"image/jpeg"}),i=await N(n);return{...e,file:n,name:n.name,converted:!0,preview:i,status:"ready"}},N=e=>new Promise((s,t)=>{let l=new FileReader;l.onload=e=>{var t;return s(null===(t=e.target)||void 0===t?void 0:t.result)},l.onerror=t,l.readAsDataURL(e)}),v=async()=>{if(0===d.length){o("Пожалуйста, загрузите хотя бы один файл");return}d.some(e=>y(e.file))?await j():c(d)},D=()=>d.filter(e=>"image"===e.type),F=()=>d.filter(e=>"video"===e.type);return(0,l.jsxs)("div",{className:"bg-white rounded-lg shadow-lg p-6 max-w-4xl w-full mx-auto",children:[(0,l.jsxs)("div",{className:"mb-6",children:[(0,l.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Загрузка медиа файлов"}),(0,l.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[(0,l.jsx)("span",{children:"SKU:"}),(0,l.jsx)("span",{className:"font-mono bg-gray-100 px-2 py-1 rounded",children:s})]})]}),(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsx)(E,{onFilesChange:p,acceptedTypes:["image/jpeg","image/png","image/heic","video/mp4","video/quicktime"],maxSize:26214400,multiple:!0}),d.length>0&&(0,l.jsx)("div",{className:"bg-gray-50 rounded-lg p-4",children:(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)(w.Z,{className:"w-4 h-4 text-blue-500"}),(0,l.jsxs)("span",{children:["Изображения: ",D().length,D().some(e=>y(e.file))&&(0,l.jsx)("span",{className:"text-orange-600 ml-1",children:"(HEIC требует конвертации)"})]})]}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)(k.Z,{className:"w-4 h-4 text-green-500"}),(0,l.jsxs)("span",{children:["Видео: ",F().length]})]}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)(a.Z,{className:"w-4 h-4 text-gray-500"}),(0,l.jsxs)("span",{children:["Всего: ",d.length," файлов"]})]})]})}),m&&(0,l.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,l.jsx)("div",{className:"animate-spin w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full"}),(0,l.jsx)("span",{className:"text-sm font-medium text-blue-800",children:"Конвертация HEIC файлов в JPG..."})]}),(0,l.jsx)("div",{className:"w-full bg-blue-200 rounded-full h-2",children:(0,l.jsx)("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:"".concat(h,"%")}})}),(0,l.jsxs)("p",{className:"text-xs text-blue-600 mt-1",children:[h,"% завершено"]})]}),F().length>0&&(0,l.jsx)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:(0,l.jsxs)("div",{className:"flex items-start gap-2",children:[(0,l.jsx)(n.Z,{className:"w-4 h-4 text-yellow-600 mt-0.5"}),(0,l.jsxs)("div",{className:"text-sm text-yellow-800",children:[(0,l.jsx)("p",{className:"font-medium mb-1",children:"Важно"}),(0,l.jsx)("p",{children:"Видео файлы не будут обработаны в Photoroom. Они будут включены в финальный архив без изменений."})]})]})}),(0,l.jsxs)("div",{className:"flex flex-col sm:flex-row gap-3 pt-4 border-t",children:[(0,l.jsxs)("button",{onClick:i,className:"flex-1 bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center gap-2",children:[(0,l.jsx)(S.Z,{className:"w-4 h-4"}),"Назад"]}),(0,l.jsxs)("button",{onClick:()=>{x([])},disabled:0===d.length||m,className:"flex-1 bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 disabled:bg-red-400 transition-colors flex items-center justify-center gap-2",children:[(0,l.jsx)(C.Z,{className:"w-4 h-4"}),"Очистить"]}),(0,l.jsxs)("button",{onClick:v,disabled:0===d.length||m,className:"flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-blue-400 transition-colors flex items-center justify-center gap-2",children:[(0,l.jsx)(Z.Z,{className:"w-4 h-4"}),m?"Конвертация...":"Продолжить"]})]})]})]})}var P=t(6264),T=t(4280),O=t(6020),I=t(6141);function L(e){let{files:s,title:t="Обработка файлов",subtitle:i="Пожалуйста, дождитесь завершения обработки",onComplete:c}=e,[o,d]=(0,r.useState)(0),[x,m]=(0,r.useState)(0);(0,r.useEffect)(()=>{let e=s.filter(e=>"done"===e.status||"skipped"===e.status).length;d(e);let t=s.filter(e=>"processing"===e.status),l=t.reduce((e,s)=>e+(s.progress||0),0),r=t.length>0?l/t.length:0;m(Math.round(e/s.length*100+r*t.length/s.length)),e===s.length&&s.length>0&&(null==c||c())},[s,c]);let g=(e,s)=>{switch(e){case"queued":return(0,l.jsx)(I.Z,{className:"w-4 h-4 text-gray-400"});case"processing":return(0,l.jsx)(P.Z,{className:"w-4 h-4 text-blue-500 animate-spin"});case"done":return(0,l.jsx)(a.Z,{className:"w-4 h-4 text-green-500"});case"error":return(0,l.jsx)(n.Z,{className:"w-4 h-4 text-red-500"});case"skipped":return(0,l.jsx)(k.Z,{className:"w-4 h-4 text-yellow-500"})}},h=e=>{switch(e){case"queued":return"В очереди";case"processing":return"Обработка...";case"done":return"Готово";case"error":return"Ошибка";case"skipped":return"Пропущено"}},u=e=>{switch(e){case"queued":return"text-gray-500";case"processing":return"text-blue-600";case"done":return"text-green-600";case"error":return"text-red-600";case"skipped":return"text-yellow-600"}},p=e=>{switch(e){case"queued":return"bg-gray-200";case"processing":return"bg-blue-500";case"done":return"bg-green-500";case"error":return"bg-red-500";case"skipped":return"bg-yellow-500"}},j=s.filter(e=>"image"===e.type),f=s.filter(e=>"video"===e.type),b=j.filter(e=>"done"===e.status).length,N=f.filter(e=>"skipped"===e.status).length;return(0,l.jsxs)("div",{className:"bg-white rounded-lg shadow-lg p-6 max-w-4xl w-full mx-auto",children:[(0,l.jsxs)("div",{className:"mb-6",children:[(0,l.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:t}),(0,l.jsx)("p",{className:"text-gray-600",children:i})]}),(0,l.jsxs)("div",{className:"mb-8",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,l.jsx)("span",{className:"text-sm font-medium text-gray-700",children:"Общий прогресс"}),(0,l.jsxs)("span",{className:"text-sm text-gray-500",children:[x,"%"]})]}),(0,l.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-3",children:(0,l.jsx)("div",{className:"bg-blue-600 h-3 rounded-full transition-all duration-500",style:{width:"".concat(x,"%")}})}),(0,l.jsxs)("div",{className:"flex justify-between text-xs text-gray-500 mt-2",children:[(0,l.jsxs)("span",{children:["Обработано: ",o,"/",s.length]}),(0,l.jsxs)("span",{children:["Изображения: ",b,", Видео: ",N]})]})]}),(0,l.jsx)("div",{className:"space-y-4 max-h-96 overflow-y-auto",children:s.map(e=>(0,l.jsxs)("div",{className:"border rounded-lg p-4 bg-gray-50",children:[(0,l.jsxs)("div",{className:"flex items-center gap-3 mb-3",children:[(0,l.jsx)("div",{className:"flex-shrink-0",children:"image"===e.type?(0,l.jsx)("div",{className:"w-10 h-10 bg-blue-100 rounded flex items-center justify-center",children:(0,l.jsx)(F.Z,{className:"w-5 h-5 text-blue-600"})}):(0,l.jsx)("div",{className:"w-10 h-10 bg-yellow-100 rounded flex items-center justify-center",children:(0,l.jsx)(k.Z,{className:"w-5 h-5 text-yellow-600"})})}),(0,l.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,l.jsx)("p",{className:"text-sm font-medium text-gray-900 truncate",children:e.originalName}),(0,l.jsx)("span",{className:"text-xs text-gray-500",children:"→"}),(0,l.jsx)("p",{className:"text-sm text-green-600 font-medium truncate",children:e.finalName.replace(/\.(\w+)\.\w+$/,".$1")})]}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[g(e.status,e.type),(0,l.jsx)("span",{className:"text-sm ".concat(u(e.status)),children:h(e.status)}),e.error&&(0,l.jsxs)("span",{className:"text-xs text-red-500",children:["(",e.error,")"]})]})]}),(0,l.jsx)("div",{className:"flex-shrink-0 w-24",children:"processing"===e.status&&void 0!==e.progress&&(0,l.jsx)("div",{className:"text-right",children:(0,l.jsxs)("div",{className:"text-xs text-blue-600 font-medium",children:[e.progress,"%"]})})})]}),(0,l.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,l.jsx)("div",{className:"h-2 rounded-full transition-all duration-300 ".concat(p(e.status)),style:{width:"processing"===e.status&&void 0!==e.progress?"".concat(e.progress,"%"):"done"===e.status||"skipped"===e.status?"100%":"0%"}})})]},e.id))}),(0,l.jsx)("div",{className:"mt-6 pt-4 border-t border-gray-200",children:(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm",children:[(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsx)("div",{className:"text-2xl font-bold text-blue-600",children:j.filter(e=>"done"===e.status).length}),(0,l.jsx)("div",{className:"text-gray-500",children:"Изображений обработано"})]}),(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsx)("div",{className:"text-2xl font-bold text-yellow-600",children:f.filter(e=>"skipped"===e.status).length}),(0,l.jsx)("div",{className:"text-gray-500",children:"Видео пропущено"})]}),(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsx)("div",{className:"text-2xl font-bold text-red-600",children:s.filter(e=>"error"===e.status).length}),(0,l.jsx)("div",{className:"text-gray-500",children:"Ошибок"})]})]})})]})}function M(e){let{sku:s,files:t,onBack:i,onComplete:c,onError:o}=e,[d,x]=(0,r.useState)([]),[m,g]=(0,r.useState)(!1),[h,u]=(0,r.useState)(null),[p,j]=(0,r.useState)(!1);(0,r.useEffect)(()=>{f()},[t,s]);let f=()=>{console.log("Initializing progress with files:",t);let e=t.map((e,t)=>{let l=b(s,t+1,e.file.name.split(".").pop()||"jpg");return{id:e.id,name:e.name,type:e.type,status:"video"===e.type?"skipped":"queued",originalName:e.name,finalName:l,progress:0}});console.log("Initialized progress files:",e),x(e)},N=async()=>{g(!0),u(new Date);try{let e=new FormData;e.append("sku",s),t.forEach(s=>{e.append("files",s.file)}),console.log("Uploading files:",t.map(e=>e.name)),console.log("FormData entries:",Array.from(e.entries()).map(e=>{let[s,t]=e;return[s,t instanceof File?t.name:t]}));let l=await fetch("/api/upload",{method:"POST",body:e});if(!l.ok){let e=await l.json().catch(()=>({}));throw console.error("Upload error response:",e),Error(e.error||"Failed to upload files")}let r=await l.json();console.log("Upload result:",r);let a={sku:s,files:r.files.map(e=>({id:e.id,fileName:e.fileName,filePath:e.filePath,type:e.type,originalName:e.originalName}))},n=d.map((e,s)=>{let t=r.files[s];return t?{...e,id:t.id,originalName:t.originalName}:e});x(n),console.log("Process payload:",a);let i=await fetch("/api/process",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!i.ok){let e=await i.json().catch(()=>({}));throw console.error("Process error response:",e),Error(e.error||"Failed to process files")}let c=await i.json();console.log("Process result:",c),console.log("Process result results:",c.results),console.log("Progress files before update:",d.map(e=>({id:e.id,name:e.name})));let o=d.map(e=>{console.log("Looking for processed file for: ".concat(e.name," (original: ").concat(e.originalName,")"));let s=c.results.find(s=>{let t=r.files.find(e=>e.originalName===s.originalName);if(t){let l=t.originalName===e.name||t.fileName===e.name;return console.log("Comparing ".concat(s.originalName," with ").concat(e.name,": name match: ").concat(l)),l}return!1});return s?(console.log("Found processed file:",s),{...e,status:s.status,finalName:s.finalName,error:s.error,processedPath:s.processedPath}):(console.log("Processed file not found for: ".concat(e.name)),e)});console.log("Updated files:",o),console.log("Updated files details:",o.map(e=>({id:e.id,name:e.name,status:e.status,finalName:e.finalName,originalName:e.originalName}))),x(o)}catch(e){console.error("Processing error:",e),o(e instanceof Error?e.message:"Произошла ошибка при обработке файлов")}finally{g(!1)}},y=()=>{c(d)},v=async()=>{x(d.map(e=>"error"===e.status?{...e,status:"queued",error:void 0}:e)),await N()},w=async()=>{j(!0);try{let e=await fetch("/api/telegram",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sku:s,chatId:"-4914435522"})});if(!e.ok){let s=await e.json().catch(()=>({}));throw Error(s.error||"Failed to send files to Telegram")}let t=await e.json();console.log("Files sent to Telegram:",t),alert("Файлы успешно отправлены в Telegram!")}catch(e){console.error("Telegram send error:",e),alert("Ошибка при отправке в Telegram: ".concat(e instanceof Error?e.message:"Unknown error"))}finally{j(!1)}},k=(()=>{let e=d.length,s=d.filter(e=>"image"===e.type).length,t=d.filter(e=>"video"===e.type).length;return{total:e,images:s,videos:t,done:d.filter(e=>"done"===e.status).length,errors:d.filter(e=>"error"===e.status).length,processing:d.filter(e=>"processing"===e.status).length}})(),C=k.errors>0,D=k.done+k.errors===k.total;return(0,l.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100",children:(0,l.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[(0,l.jsxs)("header",{className:"text-center mb-8",children:[(0,l.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Photo SKU Processor"}),(0,l.jsx)("p",{className:"text-gray-600",children:"Обработка фотографий товаров с привязкой к штрих-коду"})]}),(0,l.jsxs)("main",{className:"max-w-4xl mx-auto",children:[(0,l.jsxs)("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:"Обработка файлов"}),(0,l.jsxs)("p",{className:"text-sm text-gray-600",children:["SKU: ",s]})]}),m&&(0,l.jsxs)("div",{className:"flex items-center gap-2 text-sm text-blue-600",children:[(0,l.jsx)(P.Z,{className:"w-4 h-4 animate-spin"}),(0,l.jsx)("span",{children:"Обработка..."})]})]}),(0,l.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[(0,l.jsxs)("div",{className:"bg-blue-50 rounded-lg p-3 text-center",children:[(0,l.jsx)("div",{className:"text-2xl font-bold text-blue-600",children:k.images}),(0,l.jsx)("div",{className:"text-xs text-gray-600",children:"Изображений"})]}),(0,l.jsxs)("div",{className:"bg-yellow-50 rounded-lg p-3 text-center",children:[(0,l.jsx)("div",{className:"text-2xl font-bold text-yellow-600",children:k.videos}),(0,l.jsx)("div",{className:"text-xs text-gray-600",children:"Видео"})]}),(0,l.jsxs)("div",{className:"bg-green-50 rounded-lg p-3 text-center",children:[(0,l.jsx)("div",{className:"text-2xl font-bold text-green-600",children:k.done}),(0,l.jsx)("div",{className:"text-xs text-gray-600",children:"Готово"})]}),(0,l.jsxs)("div",{className:"bg-red-50 rounded-lg p-3 text-center",children:[(0,l.jsx)("div",{className:"text-2xl font-bold text-red-600",children:k.errors}),(0,l.jsx)("div",{className:"text-xs text-gray-600",children:"Ошибок"})]})]}),k.videos>0&&(0,l.jsx)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6",children:(0,l.jsxs)("div",{className:"flex items-start gap-2",children:[(0,l.jsx)(n.Z,{className:"w-4 h-4 text-yellow-600 mt-0.5"}),(0,l.jsxs)("div",{className:"text-sm text-yellow-800",children:[(0,l.jsx)("p",{className:"font-medium mb-1",children:"Важно"}),(0,l.jsx)("p",{children:"Видео файлы не будут обработаны в Photoroom. Они будут включены в финальный архив без изменений."})]})]})}),!m&&0===k.done&&(0,l.jsxs)("div",{className:"text-center mb-6",children:[(0,l.jsxs)("button",{onClick:()=>{console.log("Start processing clicked, files:",t),console.log("Progress files before start:",d),N()},disabled:0===t.length,className:"bg-blue-600 text-white py-3 px-8 rounded-lg hover:bg-blue-700 disabled:bg-blue-400 transition-colors flex items-center gap-2 mx-auto",children:[(0,l.jsx)(T.Z,{className:"w-4 h-4"}),"Начать обработку"]}),(0,l.jsx)("p",{className:"text-sm text-gray-500 mt-2",children:"Максимально 3 файла обрабатываются одновременно"})]}),C&&!m&&(0,l.jsx)("div",{className:"text-center mb-6",children:(0,l.jsxs)("button",{onClick:v,className:"bg-orange-600 text-white py-2 px-6 rounded-lg hover:bg-orange-700 transition-colors flex items-center gap-2 mx-auto",children:[(0,l.jsx)(T.Z,{className:"w-4 h-4"}),"Повторить обработку ошибочных файлов"]})}),D&&!m&&(0,l.jsx)("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-6",children:(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)(a.Z,{className:"w-5 h-5 text-green-600"}),(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"font-medium text-green-800",children:"Обработка завершена!"}),(0,l.jsxs)("p",{className:"text-sm text-green-600",children:[k.done," файлов успешно обработано"]})]})]})})]}),(0,l.jsx)(L,{files:d,title:"Прогресс обработки",subtitle:"Следите за статусом каждого файла",onComplete:y}),(0,l.jsxs)("div",{className:"flex flex-col sm:flex-row gap-3 mt-6",children:[(0,l.jsxs)("button",{onClick:i,className:"flex-1 bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center gap-2",children:[(0,l.jsx)(S.Z,{className:"w-4 h-4"}),"Назад"]}),D&&!m&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("button",{onClick:w,disabled:p,className:"flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-blue-400 transition-colors flex items-center justify-center gap-2",children:p?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(P.Z,{className:"w-4 h-4 animate-spin"}),"Отправка..."]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(O.Z,{className:"w-4 h-4"}),"Отправить в Telegram"]})}),(0,l.jsxs)("button",{onClick:y,className:"flex-1 bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2",children:[(0,l.jsx)(Z.Z,{className:"w-4 h-4"}),"Показать результаты"]})]})]})]})]})})}var V=t(5817);let R=e=>{let s=e.lastIndexOf(".");if(s>0){let t=e.substring(0,s),l=e.substring(s),r=t.lastIndexOf(".");if(r>0)return t.substring(r+1)+l}return e};function _(e){let{sku:s,files:t,onBack:i,onRestart:c,onError:o}=e,[d,x]=(0,r.useState)(!1),[m,g]=(0,r.useState)(0),[h,u]=(0,r.useState)(null),[p,j]=(0,r.useState)(!1),f=t.filter(e=>"done"===e.status),b=t.filter(e=>"skipped"===e.status),N=t.filter(e=>"error"===e.status),y=async()=>{if(0===f.length){o("Нет готовых файлов для скачивания");return}x(!0),g(0);try{let e=await fetch("/api/download",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sku:s,includeOriginals:!1})});if(!e.ok)throw Error("Failed to download ZIP file");let t=await e.blob(),l=URL.createObjectURL(t),r=document.createElement("a");r.href=l,r.download="photo-sku-".concat(s,"-").concat(new Date().toISOString().replace(/[:.]/g,"-"),".zip"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(l)}catch(e){console.error("Download error:",e),o("Произошла ошибка при скачивании ZIP файла")}finally{x(!1),g(0)}},v=async()=>{if(0===t.length){o("Нет файлов для скачивания");return}x(!0),g(0);try{let e=await fetch("/api/download",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sku:s,includeOriginals:!0})});if(!e.ok)throw Error("Failed to download ZIP file");let t=await e.blob(),l=URL.createObjectURL(t),r=document.createElement("a");r.href=l,r.download="photo-sku-".concat(s,"-").concat(new Date().toISOString().replace(/[:.]/g,"-"),"-with-originals.zip"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(l)}catch(e){console.error("Download error:",e),o("Произошла ошибка при скачивании ZIP файла")}finally{x(!1),g(0)}},w=async()=>{j(!0);try{let e=f.map(e=>({finalName:e.finalName}));if(0===e.length){alert("Нет готовых файлов для отправки в Telegram");return}console.log("Sending files to Telegram:",e);let t=await fetch("/api/telegram",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sku:s,files:e})});if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.error||"Failed to send files to Telegram")}let l=await t.json();console.log("Files sent to Telegram:",l),alert("Файлы успешно отправлены в Telegram!")}catch(e){console.error("Telegram send error:",e),alert("Ошибка при отправке в Telegram: ".concat(e instanceof Error?e.message:"Unknown error"))}finally{j(!1)}},C=e=>"image"===e.type&&"done"===e.status&&e.previewUrl?(console.log("Using preview URL for ".concat(e.originalName,": ").concat(e.previewUrl)),e.previewUrl):(console.log("Using placeholder for ".concat(e.originalName,", status: ").concat(e.status)),"image"===e.type?"/placeholder-image.jpg":"/placeholder-video.jpg");return(0,l.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100",children:(0,l.jsx)("div",{className:"container mx-auto px-4 py-8",children:(0,l.jsxs)("main",{className:"max-w-4xl mx-auto",children:[(0,l.jsxs)("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:[(0,l.jsxs)("div",{className:"text-center mb-6",children:[(0,l.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Обработка завершена!"}),(0,l.jsxs)("p",{className:"text-gray-600",children:["SKU: ",s]})]}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[(0,l.jsxs)("div",{className:"bg-blue-50 rounded-lg p-4 text-center",children:[(0,l.jsx)("div",{className:"text-3xl font-bold text-blue-600 mb-2",children:f.length}),(0,l.jsx)("div",{className:"text-sm text-gray-600",children:"Изображений обработано"})]}),(0,l.jsxs)("div",{className:"bg-yellow-50 rounded-lg p-4 text-center",children:[(0,l.jsx)("div",{className:"text-3xl font-bold text-yellow-600 mb-2",children:b.length}),(0,l.jsx)("div",{className:"text-sm text-gray-600",children:"Видео пропущено"})]}),(0,l.jsxs)("div",{className:"bg-green-50 rounded-lg p-4 text-center",children:[(0,l.jsx)("div",{className:"text-3xl font-bold text-green-600 mb-2",children:t.length}),(0,l.jsx)("div",{className:"text-sm text-gray-600",children:"Всего файлов"})]}),(0,l.jsxs)("div",{className:"bg-red-50 rounded-lg p-4 text-center",children:[(0,l.jsx)("div",{className:"text-3xl font-bold text-red-600 mb-2",children:N.length}),(0,l.jsx)("div",{className:"text-sm text-gray-600",children:"Ошибок"})]})]}),N.length>0&&(0,l.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6",children:(0,l.jsxs)("div",{className:"flex items-start gap-2",children:[(0,l.jsx)(n.Z,{className:"w-4 h-4 text-red-600 mt-0.5"}),(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"font-medium text-red-800 mb-1",children:"Обнаружены ошибки при обработке"}),(0,l.jsx)("p",{className:"text-sm text-red-600",children:"Некоторые файлы не удалось обработать. Попробуйте загрузить их снова."})]})]})}),(0,l.jsxs)("div",{className:"space-y-3",children:[(0,l.jsx)("button",{onClick:y,disabled:d||0===f.length,className:"w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-blue-400 transition-colors flex items-center justify-center gap-2",children:d?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{className:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"}),(0,l.jsx)("span",{children:"Создание архива..."})]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(V.Z,{className:"w-4 h-4"}),"Скачать ZIP (только обработанные изображения)"]})}),(0,l.jsx)("button",{onClick:v,disabled:d||0===t.length,className:"w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 disabled:bg-gray-400 transition-colors flex items-center justify-center gap-2",children:d?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{className:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"}),(0,l.jsx)("span",{children:"Создание архива..."})]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(V.Z,{className:"w-4 h-4"}),"Скачать ZIP (включая оригиналы и видео)"]})})]}),d&&(0,l.jsxs)("div",{className:"mt-4",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,l.jsx)("span",{className:"text-sm font-medium text-gray-700",children:"Создание архива"}),(0,l.jsxs)("span",{className:"text-sm text-gray-500",children:[m,"%"]})]}),(0,l.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,l.jsx)("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:"".concat(m,"%")}})})]})]}),(0,l.jsxs)("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[(0,l.jsx)("h3",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Результаты обработки"}),(0,l.jsx)("div",{className:"space-y-4 max-h-96 overflow-y-auto",children:t.map(e=>(0,l.jsx)("div",{className:"border rounded-lg p-4 ".concat("done"===e.status?"bg-green-50 border-green-200":"skipped"===e.status?"bg-yellow-50 border-yellow-200":"error"===e.status?"bg-red-50 border-red-200":"bg-gray-50 border-gray-200"),children:(0,l.jsxs)("div",{className:"flex items-center gap-3",children:[(0,l.jsx)("div",{className:"flex-shrink-0",children:"image"===e.type?(0,l.jsx)("div",{className:"w-12 h-12 bg-blue-100 rounded flex items-center justify-center",children:(0,l.jsx)(F.Z,{className:"w-6 h-6 text-blue-600"})}):(0,l.jsx)("div",{className:"w-12 h-12 bg-yellow-100 rounded flex items-center justify-center",children:(0,l.jsx)(k.Z,{className:"w-6 h-6 text-yellow-600"})})}),(0,l.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,l.jsx)("p",{className:"text-sm font-medium text-gray-900 truncate",children:e.originalName}),(0,l.jsx)("span",{className:"text-xs text-gray-500",children:"→"}),(0,l.jsx)("p",{className:"text-sm text-green-600 font-medium truncate",children:R(e.finalName)})]}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:["done"===e.status&&(0,l.jsx)(a.Z,{className:"w-4 h-4 text-green-500"}),"skipped"===e.status&&(0,l.jsx)(k.Z,{className:"w-4 h-4 text-yellow-500"}),"error"===e.status&&(0,l.jsx)(n.Z,{className:"w-4 h-4 text-red-500"}),(0,l.jsx)("span",{className:"text-sm ".concat("done"===e.status?"text-green-600":"skipped"===e.status?"text-yellow-600":"error"===e.status?"text-red-600":"text-gray-500"),children:"done"===e.status?"Готово":"skipped"===e.status?"Пропущено":"error"===e.status?"Ошибка":"В обработке"}),e.error&&(0,l.jsxs)("span",{className:"text-xs text-red-500",children:["(",e.error,")"]})]})]}),(0,l.jsx)("div",{className:"flex-shrink-0",children:"image"===e.type&&"done"===e.status&&(0,l.jsx)("div",{className:"w-16 h-16 bg-gray-200 rounded overflow-hidden cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>u(C(e)),children:(0,l.jsx)("img",{src:C(e),alt:e.finalName,className:"w-full h-full object-cover"})})})]})},e.id))})]}),(0,l.jsxs)("div",{className:"flex flex-col sm:flex-row gap-3 mt-6",children:[(0,l.jsxs)("button",{onClick:i,className:"flex-1 bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center gap-2",children:[(0,l.jsx)(S.Z,{className:"w-4 h-4"}),"Назад"]}),(0,l.jsx)("button",{onClick:w,disabled:p,className:"flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-blue-400 transition-colors flex items-center justify-center gap-2",children:p?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(P.Z,{className:"w-4 h-4 animate-spin"}),"Отправка..."]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(O.Z,{className:"w-4 h-4"}),"Отправить в Telegram"]})}),(0,l.jsxs)("button",{onClick:async()=>{try{if(!(await fetch("/api/cleanup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sku:s})})).ok)throw Error("Failed to cleanup files");c()}catch(e){console.error("Cleanup error:",e),o("Ошибка при очистке файлов")}},className:"flex-1 bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2",children:[(0,l.jsx)(T.Z,{className:"w-4 h-4"}),"Начать заново"]})]})]})})})}function K(){let[e,s]=(0,r.useState)("sku"),[t,a]=(0,r.useState)(""),[n,i]=(0,r.useState)([]),[c,o]=(0,r.useState)([]),d=async e=>{a(e),s("media")},x=e=>{console.error("Error:",e)};return(0,l.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100",children:(0,l.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[(0,l.jsx)("header",{className:"text-center mb-8",children:(0,l.jsx)("div",{className:"flex items-center justify-center",children:(0,l.jsx)("img",{src:"/favicon.ico",alt:"Photo SKU Processor Logo",className:"h-12 w-auto"})})}),(0,l.jsxs)("main",{className:"max-w-4xl mx-auto",children:["sku"===e&&(0,l.jsx)(v,{onSKUSubmit:d,onError:x}),"media"===e&&(0,l.jsx)(U,{sku:t,onBack:()=>s("sku"),onContinue:e=>{i(e),s("processing")},onError:x}),"processing"===e&&(0,l.jsx)(M,{sku:t,files:n,onBack:()=>s("media"),onComplete:e=>{o(e),s("results")},onError:x}),"results"===e&&(0,l.jsx)(_,{sku:t,files:c,onBack:()=>s("processing"),onRestart:()=>{s("sku"),a(""),i([]),o([])},onError:x})]})]})})}}},function(e){e.O(0,[371,971,938,744],function(){return e(e.s=9328)}),_N_E=e.O()}]);